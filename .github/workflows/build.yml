name: build

on:
  workflow_dispatch:
    inputs:
      target:
        description: Which builds to run?
        type: choice
        required: true
        default: windows
        options:
          - windows
          - macos
          - linux
          - all
      release_tag:
        type: string
        required: false
        default: ""

  # Optional: pushing a version tag automatically builds+uploads to that tag's Release
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  windows:
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.target == 'windows' || github.event.inputs.target == 'all'
    runs-on: windows-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-windows
      cancel-in-progress: true
    defaults:
      run:
        working-directory: rust
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Build (release)
        run: cargo build --release

      - name: Setup 7-Zip
        uses: milliewalky/setup-7-zip@v2

      - name: Package (Windows, max)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force dist | Out-Null

          $exe = Get-ChildItem -Path "target/release" -Filter "*.exe" |
                 Sort-Object Length -Descending |
                 Select-Object -First 1
          if (-not $exe) { throw "No .exe found in rust/target/release" }

          Copy-Item $exe.FullName "dist/endless.exe" -Force

          if (Test-Path "../assets") { Copy-Item "../assets" "dist/assets" -Recurse -Force }
          if (Test-Path "assets")    { Copy-Item "assets"    "dist/assets" -Recurse -Force }

          if (Test-Path "endless-windows.zip") { Remove-Item "endless-windows.zip" -Force }
          7z a -tzip -mx=9 "endless-windows.zip" ".\dist\*"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: endless-windows
          path: rust/endless-windows.zip
          if-no-files-found: error
          retention-days: 7

      - name: Upload to GitHub Release (overwrite)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
          files: rust/endless-windows.zip
          overwrite: true

  macos:
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.target == 'macos' || github.event.inputs.target == 'all'
    runs-on: macos-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-macos
      cancel-in-progress: true
    defaults:
      run:
        working-directory: rust
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Build (release)
        run: cargo build --release

      - name: Package (macOS, max)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          BIN="$(find target/release -maxdepth 1 -type f -perm -111 -print0 | xargs -0 ls -S | head -n 1)"
          [[ -n "${BIN:-}" ]] || { echo "No executable found in rust/target/release"; exit 1; }
          cp "$BIN" "dist/endless"
          chmod +x "dist/endless"
          [[ -d "../assets" ]] && cp -R "../assets" "dist/assets" || true
          [[ -d "assets" ]] && cp -R "assets" "dist/assets" || true
          rm -f endless-macos.zip
          (cd dist && zip -9 -r ../endless-macos.zip .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: endless-macos
          path: rust/endless-macos.zip
          if-no-files-found: error
          retention-days: 7

      - name: Upload to GitHub Release (overwrite)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
          files: rust/endless-macos.zip
          overwrite: true

  linux:
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.target == 'linux' || github.event.inputs.target == 'all'
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-linux
      cancel-in-progress: true
    defaults:
      run:
        working-directory: rust
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Install Linux deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            g++ pkg-config \
            libx11-dev libasound2-dev libudev-dev \
            libwayland-dev libxkbcommon-dev

      - name: Build (release)
        run: cargo build --release

      - name: Package (Linux, max)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist
          BIN="$(find target/release -maxdepth 1 -type f -perm -111 -print0 | xargs -0 ls -S | head -n 1)"
          [[ -n "${BIN:-}" ]] || { echo "No executable found in rust/target/release"; exit 1; }
          cp "$BIN" "dist/endless"
          chmod +x "dist/endless"
          [[ -d "../assets" ]] && cp -R "../assets" "dist/assets" || true
          [[ -d "assets" ]] && cp -R "assets" "dist/assets" || true
          rm -f endless-linux.zip
          (cd dist && zip -9 -r ../endless-linux.zip .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: endless-linux
          path: rust/endless-linux.zip
          if-no-files-found: error
          retention-days: 7

      - name: Upload to GitHub Release (overwrite)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag != '')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release_tag || github.ref_name }}
          files: rust/endless-linux.zip
          overwrite: true
