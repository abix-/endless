name: build

on:
  workflow_dispatch:
    inputs:
      target:
        type: choice
        required: true
        default: all
        options:
          - windows
          - macos
          - linux
          - all
      release_channel:
        type: choice
        required: true
        default: dev
        options:
          - none
          - dev
          - custom
      release_tag:
        type: string
        required: false
        default: ""

  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  windows:
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'windows' || github.event.inputs.target == 'all'))
    runs-on: windows-latest

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-windows
      cancel-in-progress: true

    defaults:
      run:
        working-directory: rust

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Compute names
        id: vars
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $tag = ""
          $publish = "false"
          $isPreRelease = "false"
          $isDev = "false"
          $timestamp = ""

          if ("${{ github.ref }}" -like "refs/tags/v*") {
            $tag = "${{ github.ref_name }}"
            $publish = "true"
          } elseif ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $channel = "${{ github.event.inputs.release_channel }}"
            if ($channel -eq "dev") {
              $tag = "dev"
              $publish = "true"
              $isPreRelease = "true"
              $isDev = "true"
              $est = [System.TimeZoneInfo]::ConvertTimeBySystemTimeZoneId((Get-Date), "Eastern Standard Time")
              $timestamp = $est.ToString("yyyyMMdd-") + $est.ToString("hhmm").ToLower() + $est.ToString("tt").ToLower()
            } elseif ($channel -eq "custom" -and "${{ github.event.inputs.release_tag }}" -ne "") {
              $tag = "${{ github.event.inputs.release_tag }}"
              $publish = "true"
            }
          }

          if ($isDev -eq "true") {
            $zip = "endless-windows-dev-$timestamp.zip"
          } elseif ($tag -ne "") {
            $zip = "endless-windows-$tag.zip"
          } else {
            $zip = "endless-windows.zip"
          }
          "zip_name=$zip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "tag_name=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "publish_release=$publish" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "is_prerelease=$isPreRelease" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "is_dev=$isDev" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Move dev tag to latest commit
        if: github.event_name == 'workflow_dispatch' && steps.vars.outputs.is_dev == 'true'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -fa dev -m "Dev release ${{ github.sha }}"
          git push origin refs/tags/dev --force

      - name: Build (release)
        run: cargo build --release

      - name: Setup 7-Zip
        uses: milliewalky/setup-7-zip@v2

      - name: Package (Windows, max)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $zip = "${{ steps.vars.outputs.zip_name }}"

          New-Item -ItemType Directory -Force dist | Out-Null

          $exe = Get-ChildItem -Path "target/release" -Filter "*.exe" |
                 Sort-Object Length -Descending |
                 Select-Object -First 1
          if (-not $exe) { throw "No .exe found in rust/target/release" }

          Copy-Item $exe.FullName "dist/endless.exe" -Force

          if (Test-Path $zip) { Remove-Item $zip -Force }
          7z a -tzip -mx=9 $zip ".\dist\*"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: endless-windows
          path: rust/${{ steps.vars.outputs.zip_name }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload to GitHub Release (overwrite)
        if: steps.vars.outputs.publish_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          files: rust/${{ steps.vars.outputs.zip_name }}
          overwrite_files: true
          fail_on_unmatched_files: true
          prerelease: ${{ steps.vars.outputs.is_prerelease == 'true' }}

  macos:
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'macos' || github.event.inputs.target == 'all'))
    runs-on: macos-latest

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-macos
      cancel-in-progress: true

    defaults:
      run:
        working-directory: rust

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Compute names
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          tag=""
          publish_release=false
          is_prerelease=false
          is_dev=false
          timestamp=""
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            tag="${{ github.ref_name }}"
            publish_release=true
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            channel="${{ github.event.inputs.release_channel }}"
            if [[ "$channel" == "dev" ]]; then
              tag="dev"
              publish_release=true
              is_prerelease=true
              is_dev=true
              timestamp="$(TZ='America/New_York' date +%Y%m%d-%I%M%P)"
            elif [[ "$channel" == "custom" && -n "${{ github.event.inputs.release_tag }}" ]]; then
              tag="${{ github.event.inputs.release_tag }}"
              publish_release=true
            fi
          fi

          if [[ "$is_dev" == "true" ]]; then
            echo "zip_name=endless-macos-dev-$timestamp.zip" >> "$GITHUB_OUTPUT"
          elif [[ -n "$tag" ]]; then
            echo "zip_name=endless-macos-$tag.zip" >> "$GITHUB_OUTPUT"
          else
            echo "zip_name=endless-macos.zip" >> "$GITHUB_OUTPUT"
          fi
          echo "tag_name=$tag" >> "$GITHUB_OUTPUT"
          echo "publish_release=$publish_release" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$is_prerelease" >> "$GITHUB_OUTPUT"
          echo "is_dev=$is_dev" >> "$GITHUB_OUTPUT"

      - name: Move dev tag to latest commit
        if: github.event_name == 'workflow_dispatch' && steps.vars.outputs.is_dev == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -fa dev -m "Dev release ${{ github.sha }}"
          git push origin refs/tags/dev --force

      - name: Build (release)
        run: cargo build --release

      - name: Package (macOS, max)
        shell: bash
        run: |
          set -euo pipefail
          ZIP_NAME="${{ steps.vars.outputs.zip_name }}"

          mkdir -p dist
          BIN="$(find target/release -maxdepth 1 -type f -perm -111 -print0 | xargs -0 ls -S | head -n 1)"
          [[ -n "${BIN:-}" ]] || { echo "No executable found in rust/target/release"; exit 1; }

          cp "$BIN" "dist/endless"
          chmod +x "dist/endless"

          rm -f "$ZIP_NAME"
          (cd dist && zip -9 -r "../$ZIP_NAME" .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: endless-macos
          path: rust/${{ steps.vars.outputs.zip_name }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload to GitHub Release (overwrite)
        if: steps.vars.outputs.publish_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          files: rust/${{ steps.vars.outputs.zip_name }}
          overwrite_files: true
          fail_on_unmatched_files: true
          prerelease: ${{ steps.vars.outputs.is_prerelease == 'true' }}

  linux:
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'linux' || github.event.inputs.target == 'all'))
    runs-on: ubuntu-latest

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-linux
      cancel-in-progress: true

    defaults:
      run:
        working-directory: rust

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Compute names
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          tag=""
          publish_release=false
          is_prerelease=false
          is_dev=false
          timestamp=""
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            tag="${{ github.ref_name }}"
            publish_release=true
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            channel="${{ github.event.inputs.release_channel }}"
            if [[ "$channel" == "dev" ]]; then
              tag="dev"
              publish_release=true
              is_prerelease=true
              is_dev=true
              timestamp="$(TZ='America/New_York' date +%Y%m%d-%I%M%P)"
            elif [[ "$channel" == "custom" && -n "${{ github.event.inputs.release_tag }}" ]]; then
              tag="${{ github.event.inputs.release_tag }}"
              publish_release=true
            fi
          fi

          if [[ "$is_dev" == "true" ]]; then
            echo "zip_name=endless-linux-dev-$timestamp.zip" >> "$GITHUB_OUTPUT"
          elif [[ -n "$tag" ]]; then
            echo "zip_name=endless-linux-$tag.zip" >> "$GITHUB_OUTPUT"
          else
            echo "zip_name=endless-linux.zip" >> "$GITHUB_OUTPUT"
          fi
          echo "tag_name=$tag" >> "$GITHUB_OUTPUT"
          echo "publish_release=$publish_release" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$is_prerelease" >> "$GITHUB_OUTPUT"
          echo "is_dev=$is_dev" >> "$GITHUB_OUTPUT"

      - name: Move dev tag to latest commit
        if: github.event_name == 'workflow_dispatch' && steps.vars.outputs.is_dev == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -fa dev -m "Dev release ${{ github.sha }}"
          git push origin refs/tags/dev --force

      - name: Install Linux deps
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            g++ pkg-config \
            libx11-dev libasound2-dev libudev-dev \
            libwayland-dev libxkbcommon-dev

      - name: Build (release)
        run: cargo build --release

      - name: Package (Linux, max)
        shell: bash
        run: |
          set -euo pipefail
          ZIP_NAME="${{ steps.vars.outputs.zip_name }}"

          mkdir -p dist
          BIN="$(find target/release -maxdepth 1 -type f -perm -111 -print0 | xargs -0 ls -S | head -n 1)"
          [[ -n "${BIN:-}" ]] || { echo "No executable found in rust/target/release"; exit 1; }

          cp "$BIN" "dist/endless"
          chmod +x "dist/endless"

          rm -f "$ZIP_NAME"
          (cd dist && zip -9 -r "../$ZIP_NAME" .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: endless-linux
          path: rust/${{ steps.vars.outputs.zip_name }}
          if-no-files-found: error
          retention-days: 7

      - name: Upload to GitHub Release (overwrite)
        if: steps.vars.outputs.publish_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag_name }}
          files: rust/${{ steps.vars.outputs.zip_name }}
          overwrite_files: true
          fail_on_unmatched_files: true
          prerelease: ${{ steps.vars.outputs.is_prerelease == 'true' }}
