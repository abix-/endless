name: manual-build

on:
  workflow_dispatch:
    inputs:
      target:
        description: Which builds to run?
        type: choice
        required: true
        default: windows
        options:
          - windows
          - macos
          - linux
          - all

  # Optional: also build automatically when you create a version tag
  push:
    tags: ["v*"]

permissions:
  contents: write # only needed for tag->Release uploads

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            key: windows
            artifact: endless-windows
            out_zip: endless-windows.zip
          - os: macos-latest
            key: macos
            artifact: endless-macos
            out_zip: endless-macos.zip
          - os: ubuntu-latest
            key: linux
            artifact: endless-linux
            out_zip: endless-linux.zip

    # Run only the selected OS (or all). For tag builds, run all.
    if: |
      startsWith(github.ref, 'refs/tags/v') ||
      github.event.inputs.target == 'all' ||
      github.event.inputs.target == matrix.key

    runs-on: ${{ matrix.os }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.os }}
      cancel-in-progress: true

    defaults:
      run:
        working-directory: rust

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "rust -> target"

      - name: Install Linux deps
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            g++ pkg-config \
            libx11-dev libasound2-dev libudev-dev \
            libwayland-dev libxkbcommon-dev

      - name: Build (release)
        run: cargo build --release

      # Windows: max zip compression via 7-Zip
      - name: Setup 7-Zip (Windows)
        if: runner.os == 'Windows'
        uses: milliewalky/setup-7-zip@v2

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force dist | Out-Null

          $exe = Get-ChildItem -Path "target/release" -Filter "*.exe" |
                 Sort-Object Length -Descending |
                 Select-Object -First 1
          if (-not $exe) { throw "No .exe found in rust/target/release" }

          Copy-Item $exe.FullName "dist/endless.exe" -Force

          if (Test-Path "../assets") { Copy-Item "../assets" "dist/assets" -Recurse -Force }
          if (Test-Path "assets")    { Copy-Item "assets"    "dist/assets" -Recurse -Force }

          if (Test-Path "${{ matrix.out_zip }}") { Remove-Item "${{ matrix.out_zip }}" -Force }
          7z a -tzip -mx=9 "${{ matrix.out_zip }}" ".\dist\*"

      # macOS/Linux: zip -9
      - name: Package (macOS/Linux)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          BIN="$(find target/release -maxdepth 1 -type f -perm -111 -print0 \
                | xargs -0 ls -S | head -n 1)"
          [[ -n "${BIN:-}" ]] || { echo "No executable found in rust/target/release"; exit 1; }

          cp "$BIN" "dist/endless"
          chmod +x "dist/endless"

          [[ -d "../assets" ]] && cp -R "../assets" "dist/assets" || true
          [[ -d "assets" ]] && cp -R "assets" "dist/assets" || true

          rm -f "${{ matrix.out_zip }}"
          (cd dist && zip -9 -r "../${{ matrix.out_zip }}" .)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: rust/${{ matrix.out_zip }}
          if-no-files-found: error
          retention-days: 7

      # Optional: if you pushed a v* tag, also attach artifacts to the GitHub Release
      - name: Upload to GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: rust/${{ matrix.out_zip }}
