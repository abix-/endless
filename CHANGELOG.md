# Changelog

## 2026-01-27 (WIP)
- wire EcsNpcManager into main.gd (Phase 1): replace npc_manager + projectile_manager with Rust ECS
- comment out: food production, respawning, building, upgrades, active radius, NPC selection (future phases)
- spawn_npc() calls for farmers, guards, raiders with Dictionary opts

## 2026-01-27
- fix test 11: add combat_target_2/3 to get_combat_debug() (was returning -99 default)
- fix test 11: move ranged pair from 200px to 150px apart (200px spans 2 grid cells, outside 3x3 neighborhood)
- test 11 unified attacks: all 7 phases passing (melee + ranged projectile pipeline)
- remove fire_projectile() GDScript API: all projectiles now created via PROJECTILE_FIRE_QUEUE from Bevy attack_system
- remove dead constants PROJECTILE_SPEED and PROJECTILE_LIFETIME (speed/lifetime now per-projectile via AttackStats)
- unify melee and ranged attacks: attack_system fires projectiles via PROJECTILE_FIRE_QUEUE instead of direct DamageMsg
- add AttackStats::melee() (range=150, speed=500, lifetime=0.5s) and AttackStats::ranged() (range=300, speed=200, lifetime=3.0s)
- add FireProjectileMsg and PROJECTILE_FIRE_QUEUE (attack_system → process() → GPU projectile system)
- add upload_projectile() lifetime parameter (was hardcoded PROJECTILE_LIFETIME constant)
- add spawn_npc opts Dictionary: optional params (home_x/y, work_x/y, town_idx, starting_post, attack_type) with defaults
- refactor spawn_npc from 10 positional params to 4 required + Dictionary (no more -1 padding)
- add attack_type spawn param: 0=melee (default), 1=ranged (fighters only)
- add gpu_health_2/3 to get_combat_debug() for 4-NPC test scenarios
- fix test 10 phase 4: check GPU health decrease instead of per-frame damage_processed counter
- fix melee projectile speed: 9999→500 px/s (was overshooting 10px hit radius at 60fps)
- add Fighter job (job=3): combat-only NPC with AttackStats+AttackTimer, no behavior components (yellow)
- rewrite Test 10 as 6-phase TDD combat test using Fighter NPCs (GPU buffers → grid → targeting → damage → death → slot recycle)
- add phase_results tracking: each phase records timestamp + values at pass/fail, included in debug dump
- add get_combat_debug() GPU buffer direct reads and grid cell data for NPC 0 and 1
- fix test 10 phase 6 infinite spawn: missing terminal test_phase assignment caused spawn every frame
- fix raider yellow-on-spawn: remove Raiding from spawn bundle, let steal_decision_system assign first target
- fix NPCs drifting to (-1,-1): add Home.is_valid() guard to tired_system and steal_decision_system
- fix farmers stuck in bed: set GPU target to work position on spawn (not spawn position)
- fix spawn timing: decouple slot allocation from GPU dispatch count (NPC_SLOT_COUNTER + GPU_DISPATCH_COUNT)
- fix uninitialized GPU buffers on spawn: process() now reads GPU_DISPATCH_COUNT instead of GPU_READ_STATE.npc_count
- change GPU_UPDATE_QUEUE drain guards from idx < npc_count to idx < MAX_NPC_COUNT (allows spawn writes before dispatch count catches up)
- add Chunk 8.5: generic spawn + eliminate direct GPU writes
- replace 5 spawn methods (spawn_npc, spawn_guard, spawn_guard_at_post, spawn_farmer, spawn_raider) with single spawn_npc() (10 params, job-as-template)
- remove SpawnGuardMsg, SpawnFarmerMsg, SpawnRaiderMsg and their queues/drain functions/spawn systems
- remove GpuData Bevy Resource (dead-end intermediary)
- remove all direct buffer_update() calls from spawn path — all GPU writes via GPU_UPDATE_QUEUE
- fix slot mismatch bug: slot_idx carried in SpawnNpcMsg (spawn.md rating 6→8/10)
- update ecs_test.gd to use unified spawn API
- add Chunk 8: generic raider behavior systems (steal, flee, leash, recovery)
- add generic components: Stealer, CarryingFood, Raiding, Returning, Recovering
- add config components: FleeThreshold, LeashRange, WoundedThreshold
- add steal_decision_system (wounded → carrying → tired → raid nearest farm)
- add steal_arrival_system (farm pickup with yellow color, camp delivery to FoodStorage)
- add flee_system (exit combat below HP threshold, drop food)
- add leash_system (disengage combat if too far from home)
- add wounded_rest_system + recovery_system (rest until healed to 75%)
- add FoodStorage resource with GDScript API (init, add, get town/camp food, events)
- update raider spawn bundle: add Energy, Stealer, FleeThreshold(0.50), LeashRange(400), WoundedThreshold(0.25), Raiding initial state
- update tired_system to also remove Raiding/Returning states
- fix deprecated Dictionary → VarDictionary in lib.rs (6 occurrences)
- fix test 11 slider: per-test range config (10-10,000 for projectiles, 500-5,000 for NPCs)
- fix slider label overwritten every frame by NPC count display
- fix performance regression: dynamically size projectile multimesh to active count instead of max
- increase MAX_PROJECTILES from 5,000 to 50,000 (~3.2 MB VRAM, zero cost when idle)

## 2026-01-26
- add Chunk 7a: Health + Death system
- add Health component (100 HP default), Dead marker component
- add DamageMsg queue and apply_damage() GDScript API
- add damage_system (applies queued damage to Health)
- add death_system (marks entities with Dead when health <= 0)
- add death_cleanup_system (despawns Dead entities, hides on GPU)
- add get_health_debug() API for health system inspection
- add Test 9: Health/Death (validates damage, death, despawn)
- add Chunk 7b: GPU Targeting + Attack system
- add GPU combat buffers: faction (binding 9), health (binding 10), combat_target (binding 11)
- add GPU targeting algorithm in npc_compute.glsl (finds nearest enemy in 3x3 grid neighborhood)
- add Faction component (Villager=0, Raider=1) for hostility checks
- add AttackStats component (range=150px, damage=15, cooldown=1s)
- add AttackTimer component for attack cooldown tracking
- add attack_system (reads GPU targets, queues damage, sets chase target)
- add cooldown_system (decrements attack timers using FRAME_DELTA)
- add spawn_raider() GDScript API with SpawnRaiderMsg queue
- add spawn_raider_system in Bevy ECS
- add GPU_COMBAT_TARGETS and GPU_POSITIONS static Mutexes for Bevy access
- add faction/health upload to GPU on spawn (guards, farmers, raiders)
- add Test 10: Combat (5 guards vs 5 raiders, validates GPU targeting and damage)
- add InCombat marker prevents behavior systems from overriding combat chase
- fix SystemSet phases with explicit apply_deferred between Spawn and Combat
- fix combat: sync positions/health to GPU, hide dead NPCs, enhance debug
- refactor GPU-First Architecture: consolidate 10+ queues → 2 (GPU_UPDATE_QUEUE, GPU_READ_STATE)
- fix grid cells: 64px → 100px (properly covers 300px detection range with 3x3 neighborhood)
- add O(1) entity lookup via NpcEntityMap (replaces O(n) iteration in damage system)
- add slot reuse: FREE_SLOTS pool recycles dead NPC indices (infinite churn without 10K cap)
- add Chunk 7c: GPU Projectile system
- add projectile_compute.glsl shader (movement + spatial grid collision detection)
- add projectile buffers: position, velocity, damage, faction, shooter, lifetime, active, hit
- add fire_projectile() GDScript API with slot reuse via FREE_PROJ_SLOTS
- add projectile MultiMesh rendering with velocity-based rotation
- add get_projectile_count() and get_projectile_debug() APIs
- add Test 11: Projectiles (TDD test covering fire, move, collide, damage, expire, recycle)
- refactor test harness: replace 10 buttons with dropdown + run button
- fix projectile rendering: share NPC canvas item (second canvas_item_create doesn't render)
- fix projectile hit buffer: initialize to -1 (GPU zeros misread as "hit NPC 0")
- add get_projectile_trace() API for GPU buffer inspection (lifetime, active, position, hit)
- add faction-colored projectiles (blue=guard, red=raider) via proj_factions cache
- improve Test 11: spawn offset (20px forward), 50-projectile burst test

## 2026-01-25
- add Chunk 3: GPU physics with 8-buffer architecture (position, target, color, speed, grid, multimesh, arrivals)
- add EcsNpcManager owns GpuCompute (RenderingDevice not Send-safe for static Mutex)
- add spatial grid 128x128 cells with 48 NPCs/cell max
- add push constants 48-byte alignment with padding fields
- fix GPU buffer upload timing (separate GPU_NPC_COUNT static for immediate spawn)
- fix separation algorithm: accumulate proportionally instead of normalizing (boids-style)
- fix zero-distance separation: use golden angle fallback when NPCs overlap exactly
- add persistent arrival flag (NPCs don't chase target after being pushed away)
- add reset() function for EcsNpcManager (clears NPC count for scene reload)
- add arrival flag initialization on spawn (prevents stale buffer data)
- add ecs_test.tscn with 5 test scenarios and NPC count slider
- add test descriptions: arrive (target seeking), separation (push apart), both, circle, mass
- add TDD assertions: get_npc_position(), _assert_all_separated(), PASS/FAIL state
- add real-time min separation metric display
- add GPL 3.0 license
- add unified collision avoidance system (merged separation + blocking detection)
- add TCP-style exponential backoff for blocked NPCs (give up after 120 frames)
- add backoff buffer (binding 8) for per-NPC collision counter
- add get_debug_stats() for GPU state inspection (arrived count, max backoff)
- reduce separation strength from 200 to 100
- add asymmetric push: moving NPCs shove through settled NPCs (0.2x resistance)
- add TCP-style dodge: NPCs sidestep around other moving NPCs (head-on, overtaking, crossing)
- fix backoff detection: sideways pushing now counts as blocked
- fix test 1: check arrived count instead of position, wait 5s instead of 3s
- add copy debug info button to test harness
- add comprehensive documentation to lib.rs and npc_compute.glsl
- add Chunk 4: World Data API (towns, farms, beds, guard posts as Bevy Resources)
- add init_world(), add_town(), add_farm(), add_bed(), add_guard_post() GDScript API
- add get_town_center(), get_camp_position(), get_patrol_post() query functions
- add get_nearest_free_bed(), get_nearest_free_farm() for NPC assignment
- add reserve_bed(), release_bed(), reserve_farm(), release_farm() for occupancy tracking
- add get_world_stats() for debugging (counts and free slots)
- add Test 6: World Data (verifies all world data API functions)
- add Chunk 5: Guard Logic (guards patrol and rest autonomously in Bevy ECS)
- add guard state components: Patrolling, OnDuty, Resting, GoingToRest
- add Guard, Energy, HomePosition components
- add energy system (drain 0.02/tick active, recover 0.2/tick resting)
- add guard decision system (energy < 50 → go rest, energy > 80 → resume patrol)
- add guard patrol system (OnDuty 60 ticks → move to next post clockwise)
- add arrival detection from GPU buffer (ArrivalMsg queue, prev_arrivals tracking)
- add GPU_TARGET_QUEUE for Bevy→GPU target updates (systems can set NPC targets)
- add spawn_guard() and spawn_guard_at_post() GDScript API
- add Test 7: Guard Patrol (4 guards at corner posts, clockwise perimeter patrol)
- fix reset() to clear all queues (GUARD_QUEUE, ARRIVAL_QUEUE, GPU_TARGET_QUEUE)
- fix reset() to clear prev_arrivals (enables arrival detection on new tests)
- fix backoff: sideways jostling no longer increments backoff (only pushed away from target)
- reduce separation strength from 100 to 50 (prevents outer NPCs being pushed away on converge)
- add get_build_info() for DLL version verification (dynamic timestamp + commit hash)
- add build.rs for compile-time build info injection
- add /test command for clean build and test workflow
- fix test harness perf: throttle O(n²) min_sep to once per second (20 FPS → 130 FPS @ 500 NPCs)
- fix test harness perf: throttle get_debug_stats() GPU reads to once per second
- fix test harness perf: run O(n²) assertions once per test, not every frame after timer
- remove console log spam: debug info now UI-only (no godot_print/print calls)
- add "Collect Metrics" toggle (off by default) to disable all O(n²) checks and GPU reads
- skip test validation when metrics disabled (raw performance mode)
- add Chunk 6: Behavior-based NPC architecture (systems as behaviors)
- refactor guard components: HomePosition→Home, Guard.current_post→PatrolRoute
- add generic behavior systems: tired_system, resume_patrol_system, resume_work_system, patrol_system
- add WorkPosition, Working, GoingToWork components for work behavior
- add Farmer component and spawn_farmer() GDScript API
- add Test 8: Farmer Work Cycle (validates work/rest behavior)
- refactor lib.rs into modules: components, constants, resources, world, messages, gpu, systems/

## 2026-01-24
- add start menu with world size, town count, farmers/guards/raiders sliders (max 500)
- add parallel processing thread-safe state transitions (pending arrivals)
- add co-movement separation reduction (groups move without oscillation)
- add velocity damping for smooth collision avoidance
- add drift detection (working NPCs walk back if pushed off position)
- add flee/leash checks to parallel fighting path
- fix guard patrol route (clockwise perimeter, not diagonal through town)
- fix guard schedule (work 24/7, rest only when energy low)
- reduce guard posts from 6 to 4 (corner perimeter)
- reduce max farmers per farm from 4 to 1
- add farm click menu (shows occupant name)
- fix farmers entering FARMING state without farm reservation
- disable NPC size scaling with levels
- add Rust GDExtension with GPU compute: 10,000 NPCs @ 140fps
- add npc_compute.glsl shader (separation forces on GPU via Godot RenderingDevice)
- add spatial grid for O(n) neighbor lookup (128x128 cells, 48 NPCs/cell max)
- add godot-bevy integration with Bevy ECS state machine
- add NpcStateMachine bridge (GDScript pushes NPC data, pulls state changes)
- add guard patrol logic in Bevy ECS (low energy → walking, else → patrolling)
- add godot-bevy addon (BevyApp autoload, inspector panel, debugger plugin)
- add Chunk 1: Bevy ECS renders static NPCs via MultiMesh (EcsNpcManager)
- add Chunk 2: movement system with velocity, target, arrival detection
- add GDScript API: spawn_npc(), set_target(), get_npc_count()
- revise migration plan: GPU physics as Chunk 3 foundation layer
- add rust/, shaders/, scenes/, scripts/ to README architecture

## 2026-01-20
- add noise-based terrain with grass, forest, water, rock biomes
- add sprite tiling: water (2x2), dirt (2x2), forest (6 tree types 2x2)
- add terrain tile inspection on click
- fix rock sprites (2x2, variable sprite sizes)

## 2026-01-19
- add 8000x8000 world with visible border and corner markers
- add 7 named towns (Florida cities) with 1200px minimum spacing
- add farm tracking (max 4 farmers per farm, nearest free farm)
- add bed tracking (NPCs reserve closest free bed)
- add guard patrol between 6 posts with day/night shifts for even coverage
- add guard post turrets (individually upgradeable, 9999 levels, exponential cost)
- add flee behavior (guards <33% HP, raiders <50% HP, flee to home base)
- add target switching (stop chasing fleeing enemies if closer threat exists)
- add TCP-like collision avoidance (head-on, crossing, overtaking)
- add fountain 2x2 with 10x healing multiplier and halo shader
- add raider camp 5x regen (raiders excluded from fountain healing)
- add balanced combat stats: guards/raiders 120hp, 15dmg, 150 range
- add NPC names (55 first x 100 last = 5500 combinations) with rename feature
- add personality traits (9 types, 40% chance: brave, coward, efficient, hardy, lazy, strong, swift, sharpshot, berserker)
- add faction color tinting (guards blue, raiders red, farmers green)
- add faction policies panel (P key): flee thresholds, recovery, leash, off-duty behavior
- add roster panel (R key) with sorting, filtering, auto-upgrade checkboxes
- add upgrade menu: guard stats, economy, utility (10 levels each)
- add build menu with 6x6 grid slots (farms, beds, guard posts)
- add destroy buildings (right-click slot)
- add expandable building grid (double-click to unlock adjacent slots, up to 100x100)
- add town circle expands with building range
- add WANDERING state for off-duty NPCs
- add activity-specific NPC states (no translation layer)
- add per-NPC arrival radius based on building sprite size
- add loot icon for raiders carrying food
- add passive HP regen (2/hr awake, 6/hr sleeping)
- add mouse wheel zoom centers on cursor position
- add settings menu (ESC) with HP bar modes (off/damaged/always)
- add scroll speed setting (100-2000)
- add resizable combat log, consolidated UI panels, population caps
- add food tracking per town/camp with HUD display
- add sprite composition system (farm 3x3, house 2x2, camp 2x2)
- remove player sprite (camera-only control)
- fix camp placement (pick direction with most room, away from all towns)
- fix combat log freeze (batch updates)
- fix smooth separation (velocity-based instead of position jumps)
- fix raiders stuck at camp / not delivering food
- fix wounded raiders causing stack overflow (rest at camp instead of looping)

## 2026-01-18
- add projectile system with faction-colored projectiles (blue guards, red raiders)
- add level/XP system (sqrt scaling, level 9999 = 100x stats)
- add raider camps with per-camp spawning
- add attack flash effect
- add combat log with level-up notifications
- add raider AI: steal food from farms, return to camp
- add staggered separation (1/4 NPCs per frame)
- add camera culling (only render visible NPCs)
- add scan stagger (1/8 NPCs per frame for combat)
- refactor: extract config.gd, split NPC systems into manager/state/nav/combat/needs/grid/renderer

## 2026-01-01
- revive project: add HUD, basic NPC behavior

## 2025-03-02
- initial prototype: persistent state, NPC system
