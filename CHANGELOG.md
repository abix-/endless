# Changelog

## 2026-02-08
- **phase 2.5: gpu instanced npc rendering working**
  - fix npc_render.rs for Bevy 0.18 API: BindGroupLayoutDescriptor, Option<Cow> entry points
  - add depth-stencil state (Depth32Float) matching Transparent2d render pass
  - add dynamic MSAA sample count from camera Msaa component
  - fix bind group layout: remove unused mesh2d view bind group, texture at group 0
  - update npc_render.wgsl: texture bindings moved to @group(0)
  - disable old render graph Node pipeline in gpu/mod.rs (replaced by RenderCommand pattern)
  - 5 test NPCs visible as green squares via instanced draw call
  - enable sprite texture sampling in fragment shader (was solid color debug)
  - fix UV flip: remove incorrect 1.0-v inversion (wgpu uses top-left origin)
  - fix instance count: use NpcGpuData.npc_count instead of buffer length (was rendering all MAX_NPCS slots)

- **pure bevy migration phase 2-3**: wire ECS systems, add GPU compute and sprite rendering
  - wire build_app() into main.rs, verify systems tick with debug logging
  - add gpu/mod.rs: GPU compute via Bevy render graph (follows game_of_life pattern)
  - add assets/shaders/npc_compute.wgsl: simplified WGSL shader for movement
  - add render/mod.rs: 2D camera, texture atlas loading, sprite rendering
  - configure AssetPlugin to load from ../assets
  - test sprites rendering correctly (8 character sprites visible)
  - GPU compute pipeline compiles and dispatches (no data flow yet)
  - update /endless, /test, /debug skills for pure Bevy workflow

- **pure bevy migration phase 1**: convert from godot+bevy hybrid to standalone bevy app
  - remove godot dependencies: api.rs, channels.rs, rendering.rs, gpu.rs deleted (~2,000 lines)
  - keep pure bevy ECS: components.rs, resources.rs, systems/*.rs (~2,500 lines)
  - update Cargo.toml: bevy 0.18, bevy_egui 0.39, remove godot deps
  - add main.rs: bevy App entry point with window creation
  - update lib.rs: strip to build_app() + helpers only
  - migrate godot-bevy patterns to pure bevy:
    - `#[derive(Event)]` → `#[derive(Message)]` (bevy 0.17+ terminology)
    - `EventReader/Writer` → `MessageReader/Writer`
    - `Vector2` → `Vec2`
    - `PhysicsDelta` → bevy `Time` resource
  - remove BevyToGodot channel (projectile firing stubbed for phase 3)
  - window opens successfully with vulkan backend
  - systems compile but not yet wired (phase 2: GPU compute)
- update docs/README.md: reflect new pure bevy architecture

- refactor lib.rs: split into modules (2887 → 2121 lines)
  - api.rs: UI query methods with #[godot_api(secondary)] (518 lines)
  - rendering.rs: MultiMesh setup methods (283 lines)
- add town/camp info labels in main.gd showing population counts
- change raid balance: max 5 raiders per camp (was 10), 3 per raid group (was 5)
- change start menu defaults: 1 town, 10 guards per town

- add game loop phase 1: raider economy
  - camp_forage_system: camps gain 1 food/hour passive income
  - raider_respawn_system: camps spawn raiders for 5 food each (max 10 per camp)
  - hour_ticked flag in GameTime for clean hourly event triggering
- add game loop phase 2: starvation system
  - LastAteHour component tracks when NPC last ate
  - Starving marker after 24 hours without eating
  - starvation_system: adds/removes Starving, updates speed to 75%
  - healing_system: HP capped at 50% for starving NPCs
  - decision_system Eat action: updates LastAteHour, removes Starving
- add game loop phase 3: group raids
  - RaidQueue resource: simple waiting queue per faction
  - raiders join queue when picking Work, dispatch all when 5+ waiting
  - no separate coordinator system — queue checked inline in decision_system
  - transit skip now includes Raiding and Returning (no mid-journey decisions)
- add constants: CAMP_FORAGE_RATE, RAIDER_SPAWN_COST, CAMP_MAX_POP, RAID_GROUP_SIZE,
  STARVATION_HOURS, STARVING_HP_CAP, STARVING_SPEED_MULT

## 2026-02-07
- fix fountain offset: position at grid slot (0,0) instead of geometric center
  - gold ring also centered on fountain position
- simplify bed system: 1 bed per slot instead of 4 in 2x2 arrangement
  - remove bed offset calculations, place at slot center
  - build menu closes after placing bed (consistent with other buildings)
- fix FIXED_SLOTS: only fountain (0,0) is fixed, other slots checked by contents
- add building removal system: runtime add/remove of farms, beds, guard posts
  - add remove_location(type, x, y) API with NPC eviction
  - change AssignedFarm from usize index to Vector2 position (survives deletion)
  - change FarmOccupancy/BedOccupancy from Vec to HashMap<(i32,i32), i32>
  - add pos_to_key() helper for position → grid key conversion
  - guard patrol routes rebuild on add/remove (clockwise around town center)
  - evicted NPCs become idle (Working/Resting cleared, re-enter decision_system)
- fix build_menu: use npc_manager.get_town_food() instead of dead town_food array
- refactor behavior.rs: central brain architecture with SystemParam bundles
  - add FarmParams, EconomyParams, CombatParams, NpcStateParams bundles
  - consolidate 19 parameters into 4 logical groups (stays under Bevy's 16-param limit)
  - add Priority 0 arrival handling in decision_system (AtDestination marker)
  - remove redundant Priority 8 (Raiding re-target every frame) - now handled in Priority 0
  - arrival_system now minimal: marks AtDestination + proximity delivery only
- fix working farmer harvest: farmers now harvest when assigned farm becomes Ready
  - previously only harvested on arrival, not while already working
  - harvest check added to drift check loop (throttled every 30 frames)
- energy system now uses game time instead of frame-based rates
  - 6 game hours to recover from 0→100 while resting
  - 24 game hours to drain from 100→0 while active
  - respects time_scale and pause
- remove passive food production from economy_tick_system
  - food now only comes from harvesting Ready farms
- fix food storage: upgrade_menu and main.gd now use ECS API
  - npc_manager.get_town_food() and add_town_food() instead of main.town_food[]
- fix NPC inspector: HP and Energy now read from Bevy components
  - both use consistent pattern via entity lookup
  - removed redundant NpcEnergyCache sync
- add farm progress bar: visual indicator showing crop growth
  - item_icon.gdshader samples food sprite (24,9) from roguelikeSheet
  - progress bar at top (like NPC HP bar): green growing, gold ready
  - separate item_canvas_item with z=10 (above NPCs)
  - 16-float buffer: Transform2D + Color + CustomData for progress
- add Godot path and version to CLAUDE.md lessons learned
- unify decision system: consolidate 5 systems into one priority cascade
  - flee_system, leash_system, patrol_system, recovery_system → decision_system
  - priority order: flee > leash > combat > recovery > tired > patrol > wake > raid > idle
  - add on_duty_tick_system for guard tick counting
  - simplify energy_system to drain/recovery only (no state transitions)
  - eliminates scattered decision-making and command sync race conditions
- implement eat action: consume food from town storage, restore 30 energy instantly
  - no travel required, NPCs eat at current location
  - only scored when town actually has food (prevents stuck eat loops)
- fix rest loop: move wake-up from energy_system to decision_system
  - avoids Bevy command sync race where Resting removal wasn't visible to decision_system
  - farmers now properly wake at 90% energy and pick Work instead of Rest
- fix farmer arrival: use WorkPosition instead of current position for farm lookup
  - prevents "Working (no farm)" when separation forces push farmer away
- tighten farmer placement: ARRIVAL_THRESHOLD 40→20px, MAX_DRIFT 50→20px
  - farmers stay visually on the farm sprite
- fix build.rs: always rerun so DLL timestamp updates every build
- add ENERGY_FROM_EATING (30.0) and ENERGY_TIRED_THRESHOLD (30.0) constants
- slim down CLAUDE.md: move reference material to docs/README.md

## 2026-02-02
- add AssignedFarm component for farm occupancy tracking
  - farmers get AssignedFarm(farm_idx) when entering Working state
  - reserves farm (FarmOccupancy.occupant_count++)
  - target set to farm position so farmers return if pushed away
- add working farmer drift check (throttled every 30 frames)
  - re-targets farmers who drifted >50px from assigned farm
- energy_system removes Working when energy < 30%
  - releases farm, removes AssignedFarm
  - farmer then enters decision_system and can choose to rest
- death_cleanup_system releases farm if dead NPC had AssignedFarm
- fix food storage: read from Bevy resource instead of dead static
- fix item MultiMesh buffer size mismatch (was using farm_data.len() instead of MAX_FARMS)

## 2026-02-01
- add farm growth system: farms have growing → ready cycle
  - FarmStates resource tracks Growing/Ready state and progress per farm
  - farm_growth_system advances progress based on game time
  - hybrid growth: passive 0.08/hour (~12h), tended 0.25/hour (~4h with farmer)
  - farmers harvest ready farms on arrival (adds food, resets growth)
  - raiders can only steal from ready farms (otherwise seek another)
  - ready farms show yellow food icon via build_item_multimesh()
- add find_location_within_radius() to world.rs
  - returns (index, position) for locations within radius
  - find_nearest_location() now wraps it for backward compatibility
  - used by arrival_system for clean farm harvest/steal logic
- add MAX_FARMS constant (500), item MultiMesh allocates extra slots
- fix farm data stutter: cache BevyApp reference in ready()
  - add bevy_app_cache field to EcsNpcManager
  - add get_bevy_app_cached() for hot paths (process())
  - eliminates 60 scene tree traversals per second
- remove dead code: FREE_SLOTS and NPC_SLOT_COUNTER statics
  - SlotAllocator Bevy resource replaced these
- update messages.md: fix outdated UI query state section
  - doc claimed static Mutexes but code uses Bevy Resources
  - correct architecture table counts
- track deaths by job: show farmer/guard/raider deaths separately in UI
  - add dead field to PopStats (tracks by job + town)
  - add pop_inc_dead() helper, call in death_cleanup_system
  - expose farmers_dead, guards_dead, raiders_dead in get_population_stats()
  - left_panel.gd now shows guard deaths instead of "-"
- fix raider healing: unify settlements as towns with faction
  - add "town_center" location type replacing "fountain" and "camp"
  - Town struct now has sprite_type field (0=fountain, 1=tent)
  - remove Camp struct and add_town() - all settlements are towns
  - raiders now heal at their camps (same-faction town center)
  - add healing debug stats: healing_in_zone_count, healing_healed_count, healing_towns_count
- fix location MultiMesh rebuild spam: remove per-add rebuild, use build_locations() once
- optimize GPU buffer updates: batch uploads reduce ~670 → ~8 buffer_update() calls/frame
  - add DirtyRange tracking for each buffer type
  - drain loop updates CPU caches, then batch uploads dirty ranges
  - add upload_*_range() methods to GpuCompute for each buffer
  - add CPU caches for arrivals, backoffs, speeds
- remove dead code: sprite_frame_buffer never read by shader
  - remove binding 12 from shader and Rust uniform set
  - keep CPU cache for multimesh builder
- remove GPU multimesh writes (already done earlier, was dead code)
- fix color.a state hack: use arrival flag instead of overloaded alpha
  - shader now checks `settled == 0` instead of `color.a > 0.0`
  - color buffer is now purely visual (faction tinting)

## 2026-01-31
- move locations to ECS: eliminate all Location nodes (~260 nodes → 0)
  - add unified add_location(type, x, y, town_idx, opts) API
  - types: "farm", "bed", "guard_post", "camp", "fountain"
  - add build_locations() to build/rebuild location MultiMesh
  - sprite definitions moved to Rust (world.rs): SPRITE_FARM, SPRITE_TENT, etc.
  - main.gd stores positions instead of node references
  - delete location.gd, location.tscn, location_renderer.gd, location_renderer.tscn
- reduce location node overhead: 1117 → 657 nodes (~460 removed)
  - location.tscn: removed CollisionShape2D, changed Area2D → Node2D
  - location.gd: queue_free() labels for farms/beds/posts instead of hiding
  - add get_location_at_position() API for click selection without Area2D collision
- fix godot_ms timing: use previous frame's ECS time for accurate measurement
  - frame_ms spans process-to-process, was wrongly subtracting current frame's ECS
  - add prev_ecs_total_ms field to PerfStats for correct calculation
- add render time profiling: RenderingServer.viewport_get_measured_render_time_cpu/gpu
  - shows actual Godot rendering overhead in perf stats
  - cleaned up misleading Performance.TIME_PROCESS display
- optimize FFI calls: get_selected_npc() returns {idx, position, target} in single call
  - TargetOverlay uses cached values instead of re-fetching (eliminates 4 FFI calls/frame)
  - reduces 7 FFI calls to 1 when NPC selected
- change start menu defaults: 4 guards per town, 3 raiders per camp
- fix raider food delivery at wrong location after combat
  - event-based Returning arrival now re-targets home instead of delivering
  - only proximity check (within 150px of home) delivers food
  - prevents raiders delivering food at guard's last position after combat chase
- add debug stats caching: arrival/backoff stats computed during main sync
  - get_debug_stats() no longer does extra GPU reads
  - stats stored in PERF_STATS for cheap retrieval
- add UI throttling optimizations
  - left_panel, farm_menu, guard_post_menu: update every 30 frames (was 10 or every frame)
  - _set_text() helper skips label updates when text unchanged (avoids layout recalc)
  - Detail OFF mode skips all Rust calls (just shows FPS/zoom)
- add physics optimization: disable Area2D monitoring on locations
- add vsync=0 default in project.godot
- add GPU-side spatial grid building: eliminates 3MB CPU→GPU upload per frame
  - mode 0: clear grid counts (one thread per cell)
  - mode 1: insert NPCs via atomicAdd (one thread per NPC)
  - mode 2: main NPC logic (existing code)
  - 3 dispatches with barriers, single compute list
  - ~30% faster at 9K NPCs (58→75 FPS)
- add NPC decision logging: 100-entry circular buffer per NPC with timestamps
  - decisions logged as "Action (e:XX h:XX)" showing energy and health
  - state transitions logged ("→ OnDuty", "→ Resting", "Stole food → Returning")
- add scrollable log display in left panel inspector
- add DLL build time on start menu for version verification
- add performance profiling: get_perf_stats() API with timing breakdown
  - queue_ms, dispatch_ms, readpos_ms, combat_ms, build_ms, upload_ms
  - bevy_ms for Bevy ECS systems timing
  - displayed in left panel with other stats
- fix HP-based work score: NPCs below 50% HP won't work/raid
  - score scales from 0 at 50% to full at 100% HP
  - applies to all jobs (prevents wounded raiders from raiding)
- fix recovery_system: Resting no longer required to exit Recovering
  - NPCs that lost Resting marker were stuck in Recovering forever

## 2026-01-30
- add FactionStats resource: per-faction alive/dead/kills tracking
  - init_faction_stats(), get_faction_stats(), get_all_faction_stats() API
  - inc_alive() on spawn, dec_alive()/inc_dead() on death
  - left_panel.gd shows aggregated raider dead counts
- add multi-faction support: Faction changed from enum to struct(i32)
  - faction 0 = villagers (all towns share)
  - faction 1+ = each raider camp is unique faction
  - raiders fight each other (GPU targeting uses != comparison)
- add raider faction colors: 10-color palette cycles per faction
- add CarriedItem component for visual item display above NPC heads
  - separate MultiMesh layer for carried items (O(1) draw calls)
  - SetCarriedItem GPU update message
- fix proximity-based arrival for Returning and GoingToRest
  - uses DELIVERY_RADIUS (150px, same as healing aura)
  - fixes raiders/resting NPCs getting stuck waiting for exact arrival
- fix raiders deliver to their own camp (not hardcoded camp 0)
- change game defaults to stress test mode: 10 towns, 50 guards, 35 raiders
- change start menu: stress test mode enabled by default

## 2026-01-30
- add Wandering state marker (fixes NPCs showing "Idle" while walking to wander target)
  - add Wandering component to components.rs
  - decision_system now inserts Wandering marker when choosing Action::Wander
  - arrival_system clears Wandering on arrival (back to decision_system)
  - derive_npc_state() returns "Wandering" for wandering NPCs
- refactor: unified slot allocator in Bevy (fixes zombie NPCs)
  - spawn and death now both use SlotAllocator bevy resource
  - removed static FREE_SLOTS and NPC_SLOT_COUNTER
  - get_npc_count() now reads from SlotAllocator.count()
  - fixes slot recycling mismatch that caused zombie NPCs
- add debug info to get_population_stats() for diagnosing UI count issues
  - returns _debug_towns, _debug_cache_total, _debug_health_len
- fix: dead NPC slots now fully cleaned up (prevents zombie NPCs walking from -9999,-9999)
  - HideNpc now resets position, target, arrival, and health (was only position)
  - fixes slot recycling bug where new NPCs would walk from death position
- fix: NPC click selection uses slot counter instead of dispatch count (timing issue)
  - get_npc_at_position, get_npc_position, get_npc_health now use NPC_SLOT_COUNTER
  - fixes NPCs becoming unclickable after some time
- fix: skip drawing target line for dead selected NPCs (was drawing to -9999,-9999)
- change: ARRIVAL_THRESHOLD increased from 8px to 40px (easier food drop-off)
- fix: NPCs now wake from Resting when energy reaches 90% (was stuck forever)
- add healing aura: NPCs heal 5 HP/sec when near own faction's town center (150px radius)
  - add MaxHealth component for per-NPC health cap (supports future leveling)
  - add Healing marker component for visual state tracking
  - add healing_system in health.rs, GpuUpdate::SetHealing message
  - shader halo effect not working yet (healing logic works)
- add raid continuation: raiders keep Raiding marker after combat, decision_system re-targets nearest farm
- add find_nearest_location(pos, world, LocationKind) generic helper in world.rs
- delete all legacy gdscript npc systems (rust ECS is now single source of truth)
  - npc_manager.gd, npc_manager.tscn, npc_navigation.gd
  - npc_combat.gd, npc_needs.gd, npc_grid.gd, npc_renderer.gd
  - gpu_separation.gd, separation_compute.glsl
  - guard_post_combat.gd, projectile_manager.gd
- remove .uid files from git tracking (auto-generated by godot)
- update roadmap: add missing features from deleted files
  - trait combat/flee modifiers, target switching
  - guard post auto-attack, town policies, icon overlays
  - food consumption, hp regen, healing upgrades
- clean up readme: move all feature tracking to docs/roadmap.md
  - readme now intro only (gameplay, controls, credits)
  - reorder: The Struggle and Controls before Inspirations
  - add proper credits for godot, bevy, godot-bevy
- rename "Rust Migration Roadmap" to "Roadmap" (migration complete)
- update CLAUDE.md: remove obsolete gdscript sections
- update docs/README.md: add guard_post_menu.gd, terrain_sprite.gdshader to file map
- remove icon.svg, tmp files, add *.tmp to gitignore
- refactor: rust returns state/job/trait as strings instead of integers
- add derive_npc_state() returns "Idle", "Fighting", "On Duty", etc.
- add job_name() returns "Farmer", "Guard", "Raider", "Fighter"
- add trait_name() returns "Brave", "Coward", "Efficient", etc.
- update get_npc_info() and get_npcs_by_town(): state/job/trait now strings
- update left_panel.gd, roster_panel.gd: use strings directly from rust
- update combat_log.gd: remove NPCState dependency
- delete systems/npc_state.gd: all NPC data now sourced from rust ECS
- refactor: consolidate arrival handlers into single generic arrival_system
- delete handle_arrival_system, raider_arrival_system, wounded_rest_system
- arrival_system transitions based on state markers (component-driven, not job-driven)

## 2026-01-29
- docs: reorganize roadmap from phases to capabilities
- docs: move Data Ownership table to messages.md
- docs: move Key Optimizations and Performance Lessons to gpu-compute.md
- docs: add Testing & Debug capability section
- add Phase 11.7: replace 5 static queues with lock-free crossbeam channels
- add GodotToBevy channel (spawn, target, damage, reset, pause, timescale)
- add BevyToGodot channel (projectile fire, future sync messages)
- add godot_to_bevy_read system: drains channel, dispatches to Bevy messages/resources
- remove SPAWN_QUEUE, TARGET_QUEUE, DAMAGE_QUEUE, PROJECTILE_FIRE_QUEUE, RESET_BEVY statics
- remove drain_spawn_queue, drain_target_queue, drain_damage_queue systems
- update lib.rs spawn_npc, set_target, apply_damage: send via channel
- update lib.rs process(): drain BevyToGodot for FireProjectile messages
- add ResetFlag resource (replaces RESET_BEVY static)
- pattern: crossbeam channels for cross-thread, statics only at lib.rs boundary
- add Phase 10.2: GPU update messages replace direct Mutex locks
- add GpuUpdateMsg message type (wraps GpuUpdate enum)
- add collect_gpu_updates system: drains messages, single Mutex lock at end of frame
- update spawn_npc_system: uses MessageWriter<GpuUpdateMsg>
- update behavior systems (8 systems): use MessageWriter<GpuUpdateMsg>
- update attack_system: uses MessageWriter<GpuUpdateMsg>
- pattern: godot-bevy Messages for high-frequency batch operations (not Observers)

## 2026-01-28
- add Time API: get_game_time(), set_time_scale(), set_paused() via BevyApp world access
- add get_npc_log() API: per-NPC activity log with timestamps
- add get_bevy_app() helper: fetches BevyApp autoload for direct Bevy resource access
- delete world_clock.gd: time now handled by Bevy GameTime resource
- update main.gd, left_panel.gd, combat_log.gd to use ECS time API
- add CombatOrigin component: stores position where combat started
- fix leash_system: now measures distance from combat origin, not home (allows raiders to travel far for raids without premature leashing)
- fix flee_system and leash_system: clear Raiding marker when disengaging (prevents stuck state after returning home)
- fix raider arrival bug: verify raider is within 100px of farm before food pickup (prevents stale arrival events from spawn/home triggering false pickups)
- fix fake arrival bug: blocked NPCs no longer trigger arrival, cap backoff at 200 instead of giving up
- add get_npc_target() API: returns NPC movement target from cached GPU data
- add target visualization: selected NPC shows cyan line to target + magenta crosshair marker
- add targets cache in GpuState for CPU-side target tracking
- delete raider_idle_system: dead code now absorbed into npc_decision_system
- disable autospawning: comment out check_respawns call (code kept for later)
- remove console spam from economy_tick_system and produce_food
- add utility AI: weighted random decision system replaces priority cascades
- add Personality component: 0-2 traits (Brave, Tough, Swift, Focused) with magnitude 0.5-1.5
- add TraitKind, TraitInstance types for trait data
- add npc_decision_system: scores Eat/Rest/Work/Wander actions, weighted random selection
- remove tired_system, resume_patrol_system, resume_work_system, raider_idle_system (absorbed into npc_decision_system)
- add action score constants (SCORE_FIGHT_BASE, SCORE_WORK_BASE, SCORE_WANDER_BASE, etc.)
- change start menu sliders: now per-town values instead of totals (2 farmers, 4 guards, 6 raiders default)
- update config.gd defaults to match (BASE_FARMERS=2, BASE_GUARDS=4, BASE_RAIDERS=6)
- add Phase 9.4: UI data queries (10 new APIs for population stats, NPC info, roster, selection)
- add unified Town model: all settlements are "towns" with faction field (0=Villager, 1=Raider)
- add NPC_META static: per-NPC name/level/xp/trait cached for UI queries
- add NPC_STATES static: per-NPC state ID updated by behavior systems
- add NPC_ENERGY static: per-NPC energy synced from Bevy
- add KILL_STATS static: tracks guard/villager kills for UI display
- add SELECTED_NPC static: currently selected NPC index for inspector
- add NPCS_BY_TOWN static: per-town NPC lists for O(1) roster queries
- add name generation: "Adjective Noun" names based on job (Swift Tiller, Brave Shield, etc.)
- add get_population_stats(), get_town_population(), get_npc_info(), get_npcs_by_town() APIs
- add get/set_selected_npc(), get_npc_name(), get_npc_trait(), set_npc_name(), get_bed_stats() APIs
- add get_npc_at_position(x, y, radius) API for click selection
- add NPC click selection in main.gd: left-click selects nearest NPC within 20px
- fix sprite rendering: store ShaderMaterial reference to prevent garbage collection, include custom_data in build_multimesh_from_cache
- update left_panel.gd: uses ECS APIs for stats, bed info, and NPC inspector
- update roster_panel.gd: uses ECS APIs for NPC roster with sorting/filtering
- update upgrade_menu.gd: uses ECS APIs for farmer/guard counts
- rename Clan component to TownId for clarity
- fix deprecated VariantArray → VarArray in lib.rs
- refactor UI to ECS-only: remove _uses_methods dual-mode code from all UI panels
- add ECS API NEEDED comments documenting required ECS API for each UI feature
- preserve old GDScript code as comments for future porting reference
- fix UI compatibility with EcsNpcManager: all UI panels now detect ECS mode and gracefully degrade
- add get_npc_health() API to EcsNpcManager for UI health queries
- add npc_manager group registration so UI can find EcsNpcManager via get_first_node_in_group()
- guard main.gd building management code to skip GDScript-only operations in ECS mode
- add Phase 9.2: food production and respawning in Bevy ECS
- add economy_tick_system: unified hourly economy (food + respawn) using PhysicsDelta
- add Clan component: universal town/camp identifier on every NPC
- add GameTime resource: Bevy-owned game time tracking (no GDScript bridge needed)
- add GameConfig resource: farmers/guards per town, spawn interval, food per hour
- add PopulationStats resource: tracks alive/working counts per (job, clan)
- add RespawnTimers resource: per-clan respawn cooldowns
- remove FRAME_DELTA static: all timing now uses godot-bevy's PhysicsDelta (Godot-synced)
- remove GAME_TIME static: game time fully owned by Bevy
- refactor cooldown_system to use PhysicsDelta instead of FRAME_DELTA
- add Animal Crossing to inspirations: existence is the game, NPCs have their own lives
- add Factorio philosophy: satisfaction of watching your creation work

## 2026-01-27
- wire EcsNpcManager into main.gd (Phase 1): replace npc_manager + projectile_manager with Rust ECS
- comment out: food production, respawning, building, upgrades, active radius, NPC selection (future phases)
- spawn_npc() calls for farmers, guards, raiders with Dictionary opts
- fix multimesh culling: set custom visibility rect on canvas item (NPCs disappeared at close zoom)
- fix test 11: add combat_target_2/3 to get_combat_debug() (was returning -99 default)
- fix test 11: move ranged pair from 200px to 150px apart (200px spans 2 grid cells, outside 3x3 neighborhood)
- test 11 unified attacks: all 7 phases passing (melee + ranged projectile pipeline)
- remove fire_projectile() GDScript API: all projectiles now created via PROJECTILE_FIRE_QUEUE from Bevy attack_system
- remove dead constants PROJECTILE_SPEED and PROJECTILE_LIFETIME (speed/lifetime now per-projectile via AttackStats)
- unify melee and ranged attacks: attack_system fires projectiles via PROJECTILE_FIRE_QUEUE instead of direct DamageMsg
- add AttackStats::melee() (range=150, speed=500, lifetime=0.5s) and AttackStats::ranged() (range=300, speed=200, lifetime=3.0s)
- add FireProjectileMsg and PROJECTILE_FIRE_QUEUE (attack_system → process() → GPU projectile system)
- add upload_projectile() lifetime parameter (was hardcoded PROJECTILE_LIFETIME constant)
- add spawn_npc opts Dictionary: optional params (home_x/y, work_x/y, town_idx, starting_post, attack_type) with defaults
- refactor spawn_npc from 10 positional params to 4 required + Dictionary (no more -1 padding)
- add attack_type spawn param: 0=melee (default), 1=ranged (fighters only)
- add gpu_health_2/3 to get_combat_debug() for 4-NPC test scenarios
- fix test 10 phase 4: check GPU health decrease instead of per-frame damage_processed counter
- fix melee projectile speed: 9999→500 px/s (was overshooting 10px hit radius at 60fps)
- add Fighter job (job=3): combat-only NPC with AttackStats+AttackTimer, no behavior components (yellow)
- rewrite Test 10 as 6-phase TDD combat test using Fighter NPCs (GPU buffers → grid → targeting → damage → death → slot recycle)
- add phase_results tracking: each phase records timestamp + values at pass/fail, included in debug dump
- add get_combat_debug() GPU buffer direct reads and grid cell data for NPC 0 and 1
- fix test 10 phase 6 infinite spawn: missing terminal test_phase assignment caused spawn every frame
- fix raider yellow-on-spawn: remove Raiding from spawn bundle, let steal_decision_system assign first target
- fix NPCs drifting to (-1,-1): add Home.is_valid() guard to tired_system and steal_decision_system
- fix farmers stuck in bed: set GPU target to work position on spawn (not spawn position)
- fix spawn timing: decouple slot allocation from GPU dispatch count (NPC_SLOT_COUNTER + GPU_DISPATCH_COUNT)
- fix uninitialized GPU buffers on spawn: process() now reads GPU_DISPATCH_COUNT instead of GPU_READ_STATE.npc_count
- change GPU_UPDATE_QUEUE drain guards from idx < npc_count to idx < MAX_NPC_COUNT (allows spawn writes before dispatch count catches up)
- add Chunk 8.5: generic spawn + eliminate direct GPU writes
- replace 5 spawn methods (spawn_npc, spawn_guard, spawn_guard_at_post, spawn_farmer, spawn_raider) with single spawn_npc() (10 params, job-as-template)
- remove SpawnGuardMsg, SpawnFarmerMsg, SpawnRaiderMsg and their queues/drain functions/spawn systems
- remove GpuData Bevy Resource (dead-end intermediary)
- remove all direct buffer_update() calls from spawn path — all GPU writes via GPU_UPDATE_QUEUE
- fix slot mismatch bug: slot_idx carried in SpawnNpcMsg (spawn.md rating 6→8/10)
- update ecs_test.gd to use unified spawn API
- add Chunk 8: generic raider behavior systems (steal, flee, leash, recovery)
- add generic components: Stealer, CarryingFood, Raiding, Returning, Recovering
- add config components: FleeThreshold, LeashRange, WoundedThreshold
- add steal_decision_system (wounded → carrying → tired → raid nearest farm)
- add steal_arrival_system (farm pickup with yellow color, camp delivery to FoodStorage)
- add flee_system (exit combat below HP threshold, drop food)
- add leash_system (disengage combat if too far from home)
- add wounded_rest_system + recovery_system (rest until healed to 75%)
- add FoodStorage resource with GDScript API (init, add, get town/camp food, events)
- update raider spawn bundle: add Energy, Stealer, FleeThreshold(0.50), LeashRange(400), WoundedThreshold(0.25), Raiding initial state
- update tired_system to also remove Raiding/Returning states
- fix deprecated Dictionary → VarDictionary in lib.rs (6 occurrences)
- fix test 11 slider: per-test range config (10-10,000 for projectiles, 500-5,000 for NPCs)
- fix slider label overwritten every frame by NPC count display
- fix performance regression: dynamically size projectile multimesh to active count instead of max
- increase MAX_PROJECTILES from 5,000 to 50,000 (~3.2 MB VRAM, zero cost when idle)

## 2026-01-26
- add Chunk 7a: Health + Death system
- add Health component (100 HP default), Dead marker component
- add DamageMsg queue and apply_damage() GDScript API
- add damage_system (applies queued damage to Health)
- add death_system (marks entities with Dead when health <= 0)
- add death_cleanup_system (despawns Dead entities, hides on GPU)
- add get_health_debug() API for health system inspection
- add Test 9: Health/Death (validates damage, death, despawn)
- add Chunk 7b: GPU Targeting + Attack system
- add GPU combat buffers: faction (binding 9), health (binding 10), combat_target (binding 11)
- add GPU targeting algorithm in npc_compute.glsl (finds nearest enemy in 3x3 grid neighborhood)
- add Faction component (Villager=0, Raider=1) for hostility checks
- add AttackStats component (range=150px, damage=15, cooldown=1s)
- add AttackTimer component for attack cooldown tracking
- add attack_system (reads GPU targets, queues damage, sets chase target)
- add cooldown_system (decrements attack timers using FRAME_DELTA)
- add spawn_raider() GDScript API with SpawnRaiderMsg queue
- add spawn_raider_system in Bevy ECS
- add GPU_COMBAT_TARGETS and GPU_POSITIONS static Mutexes for Bevy access
- add faction/health upload to GPU on spawn (guards, farmers, raiders)
- add Test 10: Combat (5 guards vs 5 raiders, validates GPU targeting and damage)
- add InCombat marker prevents behavior systems from overriding combat chase
- fix SystemSet phases with explicit apply_deferred between Spawn and Combat
- fix combat: sync positions/health to GPU, hide dead NPCs, enhance debug
- refactor GPU-First Architecture: consolidate 10+ queues → 2 (GPU_UPDATE_QUEUE, GPU_READ_STATE)
- fix grid cells: 64px → 100px (properly covers 300px detection range with 3x3 neighborhood)
- add O(1) entity lookup via NpcEntityMap (replaces O(n) iteration in damage system)
- add slot reuse: FREE_SLOTS pool recycles dead NPC indices (infinite churn without 10K cap)
- add Chunk 7c: GPU Projectile system
- add projectile_compute.glsl shader (movement + spatial grid collision detection)
- add projectile buffers: position, velocity, damage, faction, shooter, lifetime, active, hit
- add fire_projectile() GDScript API with slot reuse via FREE_PROJ_SLOTS
- add projectile MultiMesh rendering with velocity-based rotation
- add get_projectile_count() and get_projectile_debug() APIs
- add Test 11: Projectiles (TDD test covering fire, move, collide, damage, expire, recycle)
- refactor test harness: replace 10 buttons with dropdown + run button
- fix projectile rendering: share NPC canvas item (second canvas_item_create doesn't render)
- fix projectile hit buffer: initialize to -1 (GPU zeros misread as "hit NPC 0")
- add get_projectile_trace() API for GPU buffer inspection (lifetime, active, position, hit)
- add faction-colored projectiles (blue=guard, red=raider) via proj_factions cache
- improve Test 11: spawn offset (20px forward), 50-projectile burst test

## 2026-01-25
- add Chunk 3: GPU physics with 8-buffer architecture (position, target, color, speed, grid, multimesh, arrivals)
- add EcsNpcManager owns GpuCompute (RenderingDevice not Send-safe for static Mutex)
- add spatial grid 128x128 cells with 48 NPCs/cell max
- add push constants 48-byte alignment with padding fields
- fix GPU buffer upload timing (separate GPU_NPC_COUNT static for immediate spawn)
- fix separation algorithm: accumulate proportionally instead of normalizing (boids-style)
- fix zero-distance separation: use golden angle fallback when NPCs overlap exactly
- add persistent arrival flag (NPCs don't chase target after being pushed away)
- add reset() function for EcsNpcManager (clears NPC count for scene reload)
- add arrival flag initialization on spawn (prevents stale buffer data)
- add ecs_test.tscn with 5 test scenarios and NPC count slider
- add test descriptions: arrive (target seeking), separation (push apart), both, circle, mass
- add TDD assertions: get_npc_position(), _assert_all_separated(), PASS/FAIL state
- add real-time min separation metric display
- add GPL 3.0 license
- add unified collision avoidance system (merged separation + blocking detection)
- add TCP-style exponential backoff for blocked NPCs (give up after 120 frames)
- add backoff buffer (binding 8) for per-NPC collision counter
- add get_debug_stats() for GPU state inspection (arrived count, max backoff)
- reduce separation strength from 200 to 100
- add asymmetric push: moving NPCs shove through settled NPCs (0.2x resistance)
- add TCP-style dodge: NPCs sidestep around other moving NPCs (head-on, overtaking, crossing)
- fix backoff detection: sideways pushing now counts as blocked
- fix test 1: check arrived count instead of position, wait 5s instead of 3s
- add copy debug info button to test harness
- add comprehensive documentation to lib.rs and npc_compute.glsl
- add Chunk 4: World Data API (towns, farms, beds, guard posts as Bevy Resources)
- add init_world(), add_town(), add_farm(), add_bed(), add_guard_post() GDScript API
- add get_town_center(), get_camp_position(), get_patrol_post() query functions
- add get_nearest_free_bed(), get_nearest_free_farm() for NPC assignment
- add reserve_bed(), release_bed(), reserve_farm(), release_farm() for occupancy tracking
- add get_world_stats() for debugging (counts and free slots)
- add Test 6: World Data (verifies all world data API functions)
- add Chunk 5: Guard Logic (guards patrol and rest autonomously in Bevy ECS)
- add guard state components: Patrolling, OnDuty, Resting, GoingToRest
- add Guard, Energy, HomePosition components
- add energy system (drain 0.02/tick active, recover 0.2/tick resting)
- add guard decision system (energy < 50 → go rest, energy > 80 → resume patrol)
- add guard patrol system (OnDuty 60 ticks → move to next post clockwise)
- add arrival detection from GPU buffer (ArrivalMsg queue, prev_arrivals tracking)
- add GPU_TARGET_QUEUE for Bevy→GPU target updates (systems can set NPC targets)
- add spawn_guard() and spawn_guard_at_post() GDScript API
- add Test 7: Guard Patrol (4 guards at corner posts, clockwise perimeter patrol)
- fix reset() to clear all queues (GUARD_QUEUE, ARRIVAL_QUEUE, GPU_TARGET_QUEUE)
- fix reset() to clear prev_arrivals (enables arrival detection on new tests)
- fix backoff: sideways jostling no longer increments backoff (only pushed away from target)
- reduce separation strength from 100 to 50 (prevents outer NPCs being pushed away on converge)
- add get_build_info() for DLL version verification (dynamic timestamp + commit hash)
- add build.rs for compile-time build info injection
- add /test command for clean build and test workflow
- fix test harness perf: throttle O(n²) min_sep to once per second (20 FPS → 130 FPS @ 500 NPCs)
- fix test harness perf: throttle get_debug_stats() GPU reads to once per second
- fix test harness perf: run O(n²) assertions once per test, not every frame after timer
- remove console log spam: debug info now UI-only (no godot_print/print calls)
- add "Collect Metrics" toggle (off by default) to disable all O(n²) checks and GPU reads
- skip test validation when metrics disabled (raw performance mode)
- add Chunk 6: Behavior-based NPC architecture (systems as behaviors)
- refactor guard components: HomePosition→Home, Guard.current_post→PatrolRoute
- add generic behavior systems: tired_system, resume_patrol_system, resume_work_system, patrol_system
- add WorkPosition, Working, GoingToWork components for work behavior
- add Farmer component and spawn_farmer() GDScript API
- add Test 8: Farmer Work Cycle (validates work/rest behavior)
- refactor lib.rs into modules: components, constants, resources, world, messages, gpu, systems/

## 2026-01-24
- add start menu with world size, town count, farmers/guards/raiders sliders (max 500)
- add parallel processing thread-safe state transitions (pending arrivals)
- add co-movement separation reduction (groups move without oscillation)
- add velocity damping for smooth collision avoidance
- add drift detection (working NPCs walk back if pushed off position)
- add flee/leash checks to parallel fighting path
- fix guard patrol route (clockwise perimeter, not diagonal through town)
- fix guard schedule (work 24/7, rest only when energy low)
- reduce guard posts from 6 to 4 (corner perimeter)
- reduce max farmers per farm from 4 to 1
- add farm click menu (shows occupant name)
- fix farmers entering FARMING state without farm reservation
- disable NPC size scaling with levels
- add Rust GDExtension with GPU compute: 10,000 NPCs @ 140fps
- add npc_compute.glsl shader (separation forces on GPU via Godot RenderingDevice)
- add spatial grid for O(n) neighbor lookup (128x128 cells, 48 NPCs/cell max)
- add godot-bevy integration with Bevy ECS state machine
- add NpcStateMachine bridge (GDScript pushes NPC data, pulls state changes)
- add guard patrol logic in Bevy ECS (low energy → walking, else → patrolling)
- add godot-bevy addon (BevyApp autoload, inspector panel, debugger plugin)
- add Chunk 1: Bevy ECS renders static NPCs via MultiMesh (EcsNpcManager)
- add Chunk 2: movement system with velocity, target, arrival detection
- add GDScript API: spawn_npc(), set_target(), get_npc_count()
- revise migration plan: GPU physics as Chunk 3 foundation layer
- add rust/, shaders/, scenes/, scripts/ to README architecture

## 2026-01-20
- add noise-based terrain with grass, forest, water, rock biomes
- add sprite tiling: water (2x2), dirt (2x2), forest (6 tree types 2x2)
- add terrain tile inspection on click
- fix rock sprites (2x2, variable sprite sizes)

## 2026-01-19
- add 8000x8000 world with visible border and corner markers
- add 7 named towns (Florida cities) with 1200px minimum spacing
- add farm tracking (max 4 farmers per farm, nearest free farm)
- add bed tracking (NPCs reserve closest free bed)
- add guard patrol between 6 posts with day/night shifts for even coverage
- add guard post turrets (individually upgradeable, 9999 levels, exponential cost)
- add flee behavior (guards <33% HP, raiders <50% HP, flee to home base)
- add target switching (stop chasing fleeing enemies if closer threat exists)
- add TCP-like collision avoidance (head-on, crossing, overtaking)
- add fountain 2x2 with 10x healing multiplier and halo shader
- add raider camp 5x regen (raiders excluded from fountain healing)
- add balanced combat stats: guards/raiders 120hp, 15dmg, 150 range
- add NPC names (55 first x 100 last = 5500 combinations) with rename feature
- add personality traits (9 types, 40% chance: brave, coward, efficient, hardy, lazy, strong, swift, sharpshot, berserker)
- add faction color tinting (guards blue, raiders red, farmers green)
- add faction policies panel (P key): flee thresholds, recovery, leash, off-duty behavior
- add roster panel (R key) with sorting, filtering, auto-upgrade checkboxes
- add upgrade menu: guard stats, economy, utility (10 levels each)
- add build menu with 6x6 grid slots (farms, beds, guard posts)
- add destroy buildings (right-click slot)
- add expandable building grid (double-click to unlock adjacent slots, up to 100x100)
- add town circle expands with building range
- add WANDERING state for off-duty NPCs
- add activity-specific NPC states (no translation layer)
- add per-NPC arrival radius based on building sprite size
- add loot icon for raiders carrying food
- add passive HP regen (2/hr awake, 6/hr sleeping)
- add mouse wheel zoom centers on cursor position
- add settings menu (ESC) with HP bar modes (off/damaged/always)
- add scroll speed setting (100-2000)
- add resizable combat log, consolidated UI panels, population caps
- add food tracking per town/camp with HUD display
- add sprite composition system (farm 3x3, house 2x2, camp 2x2)
- remove player sprite (camera-only control)
- fix camp placement (pick direction with most room, away from all towns)
- fix combat log freeze (batch updates)
- fix smooth separation (velocity-based instead of position jumps)
- fix raiders stuck at camp / not delivering food
- fix wounded raiders causing stack overflow (rest at camp instead of looping)

## 2026-01-18
- add projectile system with faction-colored projectiles (blue guards, red raiders)
- add level/XP system (sqrt scaling, level 9999 = 100x stats)
- add raider camps with per-camp spawning
- add attack flash effect
- add combat log with level-up notifications
- add raider AI: steal food from farms, return to camp
- add staggered separation (1/4 NPCs per frame)
- add camera culling (only render visible NPCs)
- add scan stagger (1/8 NPCs per frame for combat)
- refactor: extract config.gd, split NPC systems into manager/state/nav/combat/needs/grid/renderer

## 2026-01-01
- revive project: add HUD, basic NPC behavior

## 2025-03-02
- initial prototype: persistent state, NPC system
